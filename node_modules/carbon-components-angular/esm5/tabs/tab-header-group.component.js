/**
 *
 * carbon-angular v0.0.0 | tab-header-group.component.js
 *
 * Copyright 2014, 2021 IBM
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0

 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


import { Component, QueryList, Input, HostListener, ContentChildren, ElementRef, TemplateRef } from "@angular/core";
import { TabHeader } from "./tab-header.component";
import { Subscription } from "rxjs";
var TabHeaderGroup = /** @class */ (function () {
    function TabHeaderGroup(elementRef) {
        this.elementRef = elementRef;
        /**
         * Set to `true` to put tabs in a loading state.
         */
        this.skeleton = false;
        /**
         * Set to 'true' to have all pane references associated with each tab header
         * in the tab header group cached and not reloaded on tab switching.
         */
        this.cacheActive = false;
        this.isNavigation = false;
        this.type = "default";
        /**
         * Keeps track of all the subscriptions to the tab header selection events.
         */
        this.selectedSubscriptionTracker = new Subscription();
        this.tabListVisible = false;
        /**
         * Controls the manual focusing done by tabbing through headings.
         */
        this.currentSelectedIndex = 0;
        this._cacheActive = false;
    }
    // keyboard accessibility
    /**
     * Controls the keydown events used for tabbing through the headings.
     */
    TabHeaderGroup.prototype.keyboardInput = function (event) {
        var tabHeadersArray = Array.from(this.tabHeaderQuery);
        if (event.key === "Right" || event.key === "ArrowRight") {
            if (this.currentSelectedIndex < tabHeadersArray.length - 1) {
                event.preventDefault();
                if (this.followFocus && !tabHeadersArray[this.currentSelectedIndex + 1].disabled) {
                    tabHeadersArray[this.currentSelectedIndex + 1].selectTab();
                }
                else {
                    tabHeadersArray[this.currentSelectedIndex + 1].tabItem.nativeElement.focus();
                    this.currentSelectedIndex++;
                }
            }
            else {
                event.preventDefault();
                if (this.followFocus && !tabHeadersArray[0].disabled) {
                    tabHeadersArray[0].selectTab();
                }
                else {
                    tabHeadersArray[0].tabItem.nativeElement.focus();
                    this.currentSelectedIndex = 0;
                }
            }
        }
        if (event.key === "Left" || event.key === "ArrowLeft") {
            if (this.currentSelectedIndex > 0) {
                event.preventDefault();
                if (this.followFocus && !tabHeadersArray[this.currentSelectedIndex - 1].disabled) {
                    tabHeadersArray[this.currentSelectedIndex - 1].selectTab();
                }
                else {
                    tabHeadersArray[this.currentSelectedIndex - 1].tabItem.nativeElement.focus();
                    this.currentSelectedIndex--;
                }
            }
            else {
                event.preventDefault();
                if (this.followFocus && !tabHeadersArray[tabHeadersArray.length - 1].disabled) {
                    tabHeadersArray[tabHeadersArray.length - 1].selectTab();
                }
                else {
                    tabHeadersArray[tabHeadersArray.length - 1].tabItem.nativeElement.focus();
                    this.currentSelectedIndex = tabHeadersArray.length - 1;
                }
            }
        }
        if (event.key === "Home") {
            event.preventDefault();
            if (this.followFocus && !tabHeadersArray[0].disabled) {
                tabHeadersArray[0].selectTab();
            }
            else {
                tabHeadersArray[0].tabItem.nativeElement.focus();
                this.currentSelectedIndex = 0;
            }
        }
        if (event.key === "End") {
            event.preventDefault();
            if (this.followFocus && !tabHeadersArray[tabHeadersArray.length - 1].disabled) {
                tabHeadersArray[tabHeadersArray.length - 1].selectTab();
            }
            else {
                tabHeadersArray[tabHeadersArray.length - 1].tabItem.nativeElement.focus();
                this.currentSelectedIndex = tabHeadersArray.length - 1;
            }
        }
        // `"Spacebar"` is IE11 specific value
        if ((event.key === " " || event.key === "Spacebar") && !this.followFocus) {
            tabHeadersArray[this.currentSelectedIndex].selectTab();
        }
        // dropdown list handler
        if (event.key === "Escape") {
            this.tabListVisible = false;
        }
    };
    TabHeaderGroup.prototype.focusOut = function (event) {
        if (this.tabListVisible && !this.elementRef.nativeElement.contains(event.relatedTarget)) {
            this.tabListVisible = false;
        }
    };
    TabHeaderGroup.prototype.ngAfterContentInit = function () {
        var _this = this;
        this.selectedSubscriptionTracker.unsubscribe();
        if (this.tabHeaderQuery) {
            this.tabHeaderQuery.toArray()
                .forEach(function (tabHeader) {
                tabHeader.cacheActive = _this.cacheActive;
                tabHeader.paneTabIndex = _this.isNavigation ? null : 0;
            });
        }
        var selectedSubscriptions = this.tabHeaderQuery.toArray().forEach(function (tabHeader) {
            tabHeader.selected.subscribe(function () {
                _this.currentSelectedIndex = _this.tabHeaderQuery.toArray().indexOf(tabHeader);
                // The Filter takes the current selected tab out, then all other headers are
                // deactivated and their associated pane references are also deactivated.
                _this.tabHeaderQuery.toArray().filter(function (header) { return header !== tabHeader; })
                    .forEach(function (filteredHeader) {
                    filteredHeader.active = false;
                    if (filteredHeader.paneReference) {
                        filteredHeader.paneReference.active = false;
                    }
                });
            });
        });
        this.selectedSubscriptionTracker.add(selectedSubscriptions);
        setTimeout(function () { return _this.tabHeaderQuery.toArray()[_this.currentSelectedIndex].selectTab(); });
    };
    TabHeaderGroup.prototype.ngOnChanges = function (changes) {
        var _this = this;
        if (this.tabHeaderQuery) {
            if (changes.cacheActive) {
                this.tabHeaderQuery.toArray().forEach(function (tabHeader) { return tabHeader.cacheActive = _this.cacheActive; });
            }
            if (changes.isNavigation) {
                this.tabHeaderQuery.toArray()
                    .forEach(function (tabHeader) { return tabHeader.paneTabIndex = _this.isNavigation ? null : 0; });
            }
        }
    };
    TabHeaderGroup.prototype.getSelectedTab = function () {
        var selected = this.tabHeaderQuery.toArray()[this.currentSelectedIndex];
        if (selected) {
            return selected;
        }
        return {
            headingIsTemplate: false,
            heading: ""
        };
    };
    TabHeaderGroup.prototype.showTabList = function () {
        this.tabListVisible = true;
        var focusTarget = this.tabHeaderQuery.toArray().find(function (tab) {
            var tabContainer = tab.tabItem.nativeElement.parentElement;
            return !tabContainer.classList.contains("bx--tabs__nav-item--selected");
        });
        focusTarget.tabItem.nativeElement.focus();
    };
    TabHeaderGroup.prototype.onDropdownKeydown = function (event) {
        switch (event.key) {
            case " ":
            case "Spacebar":
            case "Enter":
                event.preventDefault();
                this.showTabList();
                break;
            default:
                break;
        }
    };
    TabHeaderGroup.prototype.tabDropdownKeydown = function (event) {
        if (!this.tabListVisible) {
            return;
        }
        var target = event.target.closest("a");
        var headers = this.tabHeaderQuery.toArray().filter(function (tab) {
            return !tab.tabItem.nativeElement.parentElement.classList.contains("bx--tabs__nav-item--disabled") &&
                !tab.tabItem.nativeElement.parentElement.classList.contains("bx--tabs__nav-item--selected");
        });
        // unless focus can move, it should remain on the target
        var next = target;
        var previous = target;
        for (var i = 0; i < headers.length; i++) {
            if (headers[i].tabItem.nativeElement === target) {
                if (i + 1 < headers.length) {
                    next = headers[i + 1].tabItem.nativeElement;
                }
                if (i - 1 >= 0) {
                    previous = headers[i - 1].tabItem.nativeElement;
                }
            }
        }
        switch (event.key) {
            case "ArrowDown":
            case "Down": // IE11 specific value
                next.focus();
                break;
            case "ArrowUp":
            case "Up": // IE11 specific value
                previous.focus();
                break;
            default:
                break;
        }
    };
    TabHeaderGroup.prototype.ngOnDestroy = function () {
        this.selectedSubscriptionTracker.unsubscribe();
    };
    TabHeaderGroup.decorators = [
        { type: Component, args: [{
                    selector: "ibm-tab-header-group",
                    template: "\n\t<nav\n\t\tclass=\"bx--tabs\"\n\t\t[ngClass]=\"{\n\t\t\t'bx--skeleton': skeleton,\n\t\t\t'bx--tabs--container': type === 'container'\n\t\t}\"\n\t\trole=\"navigation\"\n\t\t[attr.aria-label]=\"ariaLabel\"\n\t\t[attr.aria-labelledby]=\"ariaLabelledby\">\n\t\t<div\n\t\t\tclass=\"bx--tabs-trigger\"\n\t\t\ttabindex=\"0\"\n\t\t\t(click)=\"showTabList()\"\n\t\t\t(keydown)=\"onDropdownKeydown($event)\">\n\t\t\t<a\n\t\t\t\thref=\"javascript:void(0)\"\n\t\t\t\tclass=\"bx--tabs-trigger-text\"\n\t\t\t\ttabindex=\"-1\"\n\t\t\t\t*ngIf=\"(!getSelectedTab().headingIsTemplate && getSelectedTab().heading != '') || getSelectedTab().headingIsTemplate\">\n\t\t\t\t<ng-container *ngIf=\"!getSelectedTab().headingIsTemplate\">\n\t\t\t\t\t{{ getSelectedTab().heading }}\n\t\t\t\t</ng-container>\n\t\t\t\t<ng-template\n\t\t\t\t\t*ngIf=\"getSelectedTab().headingIsTemplate\"\n\t\t\t\t\t[ngTemplateOutlet]=\"getSelectedTab().heading\"\n\t\t\t\t\t[ngTemplateOutletContext]=\"{$implicit: getSelectedTab().context}\">\n\t\t\t\t</ng-template>\n\t\t\t</a>\n\t\t\t<svg width=\"10\" height=\"5\" viewBox=\"0 0 10 5\">\n\t\t\t\t<path d=\"M0 0l5 4.998L10 0z\" fill-rule=\"evenodd\"></path>\n\t\t\t</svg>\n\t\t</div>\n\t\t<ul\n\t\t\t#tabList\n\t\t\t[ngClass]=\"{\n\t\t\t\t'bx--tabs__nav--hidden': !tabListVisible\n\t\t\t}\"\n\t\t\t(keydown)=\"tabDropdownKeydown($event)\"\n\t\t\tclass=\"bx--tabs__nav\"\n\t\t\trole=\"tablist\">\n\t\t\t<li role=\"presentation\">\n\t\t\t\t<ng-container *ngIf=\"contentBefore\" [ngTemplateOutlet]=\"contentBefore\"></ng-container>\n\t\t\t</li>\n\t\t\t<ng-content></ng-content>\n\t\t\t<li role=\"presentation\">\n\t\t\t\t<ng-container *ngIf=\"contentAfter\" [ngTemplateOutlet]=\"contentAfter\"></ng-container>\n\t\t\t</li>\n\t\t</ul>\n\t</nav>\n\t"
                }] }
    ];
    /** @nocollapse */
    TabHeaderGroup.ctorParameters = function () { return [
        { type: ElementRef }
    ]; };
    TabHeaderGroup.propDecorators = {
        followFocus: [{ type: Input }],
        skeleton: [{ type: Input }],
        ariaLabel: [{ type: Input }],
        ariaLabelledby: [{ type: Input }],
        contentAfter: [{ type: Input }],
        contentBefore: [{ type: Input }],
        cacheActive: [{ type: Input }],
        isNavigation: [{ type: Input }],
        type: [{ type: Input }],
        tabHeaderQuery: [{ type: ContentChildren, args: [TabHeader,] }],
        keyboardInput: [{ type: HostListener, args: ["keydown", ["$event"],] }],
        focusOut: [{ type: HostListener, args: ["focusout", ["$event"],] }]
    };
    return TabHeaderGroup;
}());
export { TabHeaderGroup };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFiLWhlYWRlci1ncm91cC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9jYXJib24tY29tcG9uZW50cy1hbmd1bGFyL3RhYnMvIiwic291cmNlcyI6WyJ0YWItaGVhZGVyLWdyb3VwLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ04sU0FBUyxFQUNULFNBQVMsRUFDVCxLQUFLLEVBQ0wsWUFBWSxFQUNaLGVBQWUsRUFHZixVQUFVLEVBQ1YsV0FBVyxFQUdYLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXBDO0lBc0dDLHdCQUFzQixVQUFzQjtRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBM0M1Qzs7V0FFRztRQUNNLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFjMUI7OztXQUdHO1FBQ00sZ0JBQVcsR0FBRyxLQUFLLENBQUM7UUFFcEIsaUJBQVksR0FBRyxLQUFLLENBQUM7UUFDckIsU0FBSSxHQUE0QixTQUFTLENBQUM7UUFNbkQ7O1dBRUc7UUFDSCxnQ0FBMkIsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRTFDLG1CQUFjLEdBQUcsS0FBSyxDQUFDO1FBQzlCOztXQUVHO1FBQ0kseUJBQW9CLEdBQUcsQ0FBQyxDQUFDO1FBRXhCLGlCQUFZLEdBQUcsS0FBSyxDQUFDO0lBRWtCLENBQUM7SUFFaEQseUJBQXlCO0lBQ3pCOztPQUVHO0lBRUgsc0NBQWEsR0FEYixVQUNjLEtBQUs7UUFDbEIsSUFBSSxlQUFlLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBTSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFM0QsSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFLLE9BQU8sSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFLLFlBQVksRUFBRTtZQUN4RCxJQUFJLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDM0QsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUN2QixJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRTtvQkFDakYsZUFBZSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztpQkFDM0Q7cUJBQU07b0JBQ04sZUFBZSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO29CQUM3RSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztpQkFDNUI7YUFDRDtpQkFBTTtnQkFDTixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3ZCLElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUU7b0JBQ3JELGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztpQkFDL0I7cUJBQU07b0JBQ04sZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUM7b0JBQ2pELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxDQUFDLENBQUM7aUJBQzlCO2FBQ0Q7U0FDRDtRQUVELElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxXQUFXLEVBQUU7WUFDdEQsSUFBSSxJQUFJLENBQUMsb0JBQW9CLEdBQUcsQ0FBQyxFQUFFO2dCQUNsQyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3ZCLElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO29CQUNqRixlQUFlLENBQUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO2lCQUMzRDtxQkFBTTtvQkFDTixlQUFlLENBQUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUM7b0JBQzdFLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO2lCQUM1QjthQUNEO2lCQUFNO2dCQUNOLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDdkIsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO29CQUM5RSxlQUFlLENBQUMsZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztpQkFDeEQ7cUJBQU07b0JBQ04sZUFBZSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDMUUsSUFBSSxDQUFDLG9CQUFvQixHQUFHLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO2lCQUN2RDthQUNEO1NBQ0Q7UUFFRCxJQUFJLEtBQUssQ0FBQyxHQUFHLEtBQUssTUFBTSxFQUFFO1lBQ3pCLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUN2QixJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO2dCQUNyRCxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7YUFDL0I7aUJBQU07Z0JBQ04sZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ2pELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxDQUFDLENBQUM7YUFDOUI7U0FDRDtRQUVELElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxLQUFLLEVBQUU7WUFDeEIsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3ZCLElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRTtnQkFDOUUsZUFBZSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7YUFDeEQ7aUJBQU07Z0JBQ04sZUFBZSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDMUUsSUFBSSxDQUFDLG9CQUFvQixHQUFHLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZEO1NBQ0Q7UUFFRCxzQ0FBc0M7UUFDdEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxHQUFHLEtBQUssVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3pFLGVBQWUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUN2RDtRQUVELHdCQUF3QjtRQUN4QixJQUFJLEtBQUssQ0FBQyxHQUFHLEtBQUssUUFBUSxFQUFFO1lBQzNCLElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1NBQzVCO0lBQ0YsQ0FBQztJQUdELGlDQUFRLEdBRFIsVUFDUyxLQUFLO1FBQ2IsSUFBSSxJQUFJLENBQUMsY0FBYyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUN4RixJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQztTQUM1QjtJQUNGLENBQUM7SUFFRCwyQ0FBa0IsR0FBbEI7UUFBQSxpQkE0QkM7UUEzQkEsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRS9DLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUN4QixJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRTtpQkFDM0IsT0FBTyxDQUFDLFVBQUEsU0FBUztnQkFDakIsU0FBUyxDQUFDLFdBQVcsR0FBRyxLQUFJLENBQUMsV0FBVyxDQUFDO2dCQUN6QyxTQUFTLENBQUMsWUFBWSxHQUFHLEtBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZELENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxJQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQUEsU0FBUztZQUM1RSxTQUFTLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQztnQkFDNUIsS0FBSSxDQUFDLG9CQUFvQixHQUFHLEtBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUM3RSw0RUFBNEU7Z0JBQzVFLHlFQUF5RTtnQkFDekUsS0FBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBQSxNQUFNLElBQUksT0FBQSxNQUFNLEtBQUssU0FBUyxFQUFwQixDQUFvQixDQUFDO3FCQUNsRSxPQUFPLENBQUMsVUFBQSxjQUFjO29CQUN0QixjQUFjLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztvQkFDOUIsSUFBSSxjQUFjLENBQUMsYUFBYSxFQUFFO3dCQUNqQyxjQUFjLENBQUMsYUFBYSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7cUJBQzVDO2dCQUNGLENBQUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQywyQkFBMkIsQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUU1RCxVQUFVLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSSxDQUFDLG9CQUFvQixDQUFDLENBQUMsU0FBUyxFQUFFLEVBQXBFLENBQW9FLENBQUMsQ0FBQztJQUN4RixDQUFDO0lBRUQsb0NBQVcsR0FBWCxVQUFZLE9BQXNCO1FBQWxDLGlCQVdDO1FBVkEsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3hCLElBQUksT0FBTyxDQUFDLFdBQVcsRUFBRTtnQkFDeEIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBQSxTQUFTLElBQUksT0FBQSxTQUFTLENBQUMsV0FBVyxHQUFHLEtBQUksQ0FBQyxXQUFXLEVBQXhDLENBQXdDLENBQUMsQ0FBQzthQUM3RjtZQUVELElBQUksT0FBTyxDQUFDLFlBQVksRUFBRTtnQkFDekIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUU7cUJBQzNCLE9BQU8sQ0FBQyxVQUFBLFNBQVMsSUFBSSxPQUFBLFNBQVMsQ0FBQyxZQUFZLEdBQUcsS0FBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQXJELENBQXFELENBQUMsQ0FBQzthQUM5RTtTQUNEO0lBQ0YsQ0FBQztJQUVNLHVDQUFjLEdBQXJCO1FBQ0MsSUFBTSxRQUFRLEdBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUMzRSxJQUFJLFFBQVEsRUFBRTtZQUNiLE9BQU8sUUFBUSxDQUFDO1NBQ2hCO1FBQ0QsT0FBTztZQUNOLGlCQUFpQixFQUFFLEtBQUs7WUFDeEIsT0FBTyxFQUFFLEVBQUU7U0FDWCxDQUFDO0lBQ0gsQ0FBQztJQUVNLG9DQUFXLEdBQWxCO1FBQ0MsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBQSxHQUFHO1lBQ3pELElBQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQztZQUM3RCxPQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsOEJBQThCLENBQUMsQ0FBQztRQUN6RSxDQUFDLENBQUMsQ0FBQztRQUNILFdBQVcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzNDLENBQUM7SUFFTSwwQ0FBaUIsR0FBeEIsVUFBeUIsS0FBb0I7UUFDNUMsUUFBUSxLQUFLLENBQUMsR0FBRyxFQUFFO1lBQ2xCLEtBQUssR0FBRyxDQUFDO1lBQ1QsS0FBSyxVQUFVLENBQUM7WUFDaEIsS0FBSyxPQUFPO2dCQUNYLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDdkIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNuQixNQUFNO1lBQ1A7Z0JBQ0MsTUFBTTtTQUNQO0lBQ0YsQ0FBQztJQUVNLDJDQUFrQixHQUF6QixVQUEwQixLQUFvQjtRQUM3QyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUFFLE9BQU87U0FBRTtRQUVyQyxJQUFNLE1BQU0sR0FBSSxLQUFLLENBQUMsTUFBc0IsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFMUQsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBQSxHQUFHO1lBQ3ZELE9BQUEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyw4QkFBOEIsQ0FBQztnQkFDM0YsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyw4QkFBOEIsQ0FBQztRQUQzRixDQUMyRixDQUFDLENBQUM7UUFFOUYsd0RBQXdEO1FBQ3hELElBQUksSUFBSSxHQUFnQixNQUFNLENBQUM7UUFDL0IsSUFBSSxRQUFRLEdBQWdCLE1BQU0sQ0FBQztRQUVuQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN4QyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxLQUFLLE1BQU0sRUFBRTtnQkFDaEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUU7b0JBQzNCLElBQUksR0FBRyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUM7aUJBQzVDO2dCQUNELElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7b0JBQ2YsUUFBUSxHQUFHLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztpQkFDaEQ7YUFDRDtTQUNEO1FBRUQsUUFBUSxLQUFLLENBQUMsR0FBRyxFQUFFO1lBQ2xCLEtBQUssV0FBVyxDQUFDO1lBQ2pCLEtBQUssTUFBTSxFQUFFLHNCQUFzQjtnQkFDbEMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNiLE1BQU07WUFDUCxLQUFLLFNBQVMsQ0FBQztZQUNmLEtBQUssSUFBSSxFQUFFLHNCQUFzQjtnQkFDaEMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNqQixNQUFNO1lBQ1A7Z0JBQ0MsTUFBTTtTQUNQO0lBQ0YsQ0FBQztJQUVELG9DQUFXLEdBQVg7UUFDQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDaEQsQ0FBQzs7Z0JBbFRELFNBQVMsU0FBQztvQkFDVixRQUFRLEVBQUUsc0JBQXNCO29CQUNoQyxRQUFRLEVBQUUseXREQWtEVDtpQkFDRDs7OztnQkE5REEsVUFBVTs7OzhCQW1FVCxLQUFLOzJCQUlMLEtBQUs7NEJBSUwsS0FBSztpQ0FJTCxLQUFLOytCQUVMLEtBQUs7Z0NBRUwsS0FBSzs4QkFNTCxLQUFLOytCQUVMLEtBQUs7dUJBQ0wsS0FBSztpQ0FLTCxlQUFlLFNBQUMsU0FBUztnQ0FvQnpCLFlBQVksU0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUM7MkJBMkVsQyxZQUFZLFNBQUMsVUFBVSxFQUFFLENBQUMsUUFBUSxDQUFDOztJQTRIckMscUJBQUM7Q0FBQSxBQW5URCxJQW1UQztTQTdQWSxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0Q29tcG9uZW50LFxuXHRRdWVyeUxpc3QsXG5cdElucHV0LFxuXHRIb3N0TGlzdGVuZXIsXG5cdENvbnRlbnRDaGlsZHJlbixcblx0T25EZXN0cm95LFxuXHRBZnRlckNvbnRlbnRJbml0LFxuXHRFbGVtZW50UmVmLFxuXHRUZW1wbGF0ZVJlZixcblx0T25DaGFuZ2VzLFxuXHRTaW1wbGVDaGFuZ2VzXG59IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5cbmltcG9ydCB7IFRhYkhlYWRlciB9IGZyb20gXCIuL3RhYi1oZWFkZXIuY29tcG9uZW50XCI7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tIFwicnhqc1wiO1xuXG5AQ29tcG9uZW50KHtcblx0c2VsZWN0b3I6IFwiaWJtLXRhYi1oZWFkZXItZ3JvdXBcIixcblx0dGVtcGxhdGU6IGBcblx0PG5hdlxuXHRcdGNsYXNzPVwiYngtLXRhYnNcIlxuXHRcdFtuZ0NsYXNzXT1cIntcblx0XHRcdCdieC0tc2tlbGV0b24nOiBza2VsZXRvbixcblx0XHRcdCdieC0tdGFicy0tY29udGFpbmVyJzogdHlwZSA9PT0gJ2NvbnRhaW5lcidcblx0XHR9XCJcblx0XHRyb2xlPVwibmF2aWdhdGlvblwiXG5cdFx0W2F0dHIuYXJpYS1sYWJlbF09XCJhcmlhTGFiZWxcIlxuXHRcdFthdHRyLmFyaWEtbGFiZWxsZWRieV09XCJhcmlhTGFiZWxsZWRieVwiPlxuXHRcdDxkaXZcblx0XHRcdGNsYXNzPVwiYngtLXRhYnMtdHJpZ2dlclwiXG5cdFx0XHR0YWJpbmRleD1cIjBcIlxuXHRcdFx0KGNsaWNrKT1cInNob3dUYWJMaXN0KClcIlxuXHRcdFx0KGtleWRvd24pPVwib25Ecm9wZG93bktleWRvd24oJGV2ZW50KVwiPlxuXHRcdFx0PGFcblx0XHRcdFx0aHJlZj1cImphdmFzY3JpcHQ6dm9pZCgwKVwiXG5cdFx0XHRcdGNsYXNzPVwiYngtLXRhYnMtdHJpZ2dlci10ZXh0XCJcblx0XHRcdFx0dGFiaW5kZXg9XCItMVwiXG5cdFx0XHRcdCpuZ0lmPVwiKCFnZXRTZWxlY3RlZFRhYigpLmhlYWRpbmdJc1RlbXBsYXRlICYmIGdldFNlbGVjdGVkVGFiKCkuaGVhZGluZyAhPSAnJykgfHwgZ2V0U2VsZWN0ZWRUYWIoKS5oZWFkaW5nSXNUZW1wbGF0ZVwiPlxuXHRcdFx0XHQ8bmctY29udGFpbmVyICpuZ0lmPVwiIWdldFNlbGVjdGVkVGFiKCkuaGVhZGluZ0lzVGVtcGxhdGVcIj5cblx0XHRcdFx0XHR7eyBnZXRTZWxlY3RlZFRhYigpLmhlYWRpbmcgfX1cblx0XHRcdFx0PC9uZy1jb250YWluZXI+XG5cdFx0XHRcdDxuZy10ZW1wbGF0ZVxuXHRcdFx0XHRcdCpuZ0lmPVwiZ2V0U2VsZWN0ZWRUYWIoKS5oZWFkaW5nSXNUZW1wbGF0ZVwiXG5cdFx0XHRcdFx0W25nVGVtcGxhdGVPdXRsZXRdPVwiZ2V0U2VsZWN0ZWRUYWIoKS5oZWFkaW5nXCJcblx0XHRcdFx0XHRbbmdUZW1wbGF0ZU91dGxldENvbnRleHRdPVwieyRpbXBsaWNpdDogZ2V0U2VsZWN0ZWRUYWIoKS5jb250ZXh0fVwiPlxuXHRcdFx0XHQ8L25nLXRlbXBsYXRlPlxuXHRcdFx0PC9hPlxuXHRcdFx0PHN2ZyB3aWR0aD1cIjEwXCIgaGVpZ2h0PVwiNVwiIHZpZXdCb3g9XCIwIDAgMTAgNVwiPlxuXHRcdFx0XHQ8cGF0aCBkPVwiTTAgMGw1IDQuOTk4TDEwIDB6XCIgZmlsbC1ydWxlPVwiZXZlbm9kZFwiPjwvcGF0aD5cblx0XHRcdDwvc3ZnPlxuXHRcdDwvZGl2PlxuXHRcdDx1bFxuXHRcdFx0I3RhYkxpc3Rcblx0XHRcdFtuZ0NsYXNzXT1cIntcblx0XHRcdFx0J2J4LS10YWJzX19uYXYtLWhpZGRlbic6ICF0YWJMaXN0VmlzaWJsZVxuXHRcdFx0fVwiXG5cdFx0XHQoa2V5ZG93bik9XCJ0YWJEcm9wZG93bktleWRvd24oJGV2ZW50KVwiXG5cdFx0XHRjbGFzcz1cImJ4LS10YWJzX19uYXZcIlxuXHRcdFx0cm9sZT1cInRhYmxpc3RcIj5cblx0XHRcdDxsaSByb2xlPVwicHJlc2VudGF0aW9uXCI+XG5cdFx0XHRcdDxuZy1jb250YWluZXIgKm5nSWY9XCJjb250ZW50QmVmb3JlXCIgW25nVGVtcGxhdGVPdXRsZXRdPVwiY29udGVudEJlZm9yZVwiPjwvbmctY29udGFpbmVyPlxuXHRcdFx0PC9saT5cblx0XHRcdDxuZy1jb250ZW50PjwvbmctY29udGVudD5cblx0XHRcdDxsaSByb2xlPVwicHJlc2VudGF0aW9uXCI+XG5cdFx0XHRcdDxuZy1jb250YWluZXIgKm5nSWY9XCJjb250ZW50QWZ0ZXJcIiBbbmdUZW1wbGF0ZU91dGxldF09XCJjb250ZW50QWZ0ZXJcIj48L25nLWNvbnRhaW5lcj5cblx0XHRcdDwvbGk+XG5cdFx0PC91bD5cblx0PC9uYXY+XG5cdGBcbn0pXG5leHBvcnQgY2xhc3MgVGFiSGVhZGVyR3JvdXAgaW1wbGVtZW50cyBBZnRlckNvbnRlbnRJbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlcyB7XG5cdC8qKlxuXHQgKiBTZXQgdG8gJ3RydWUnIHRvIGhhdmUgdGFicyBhdXRvbWF0aWNhbGx5IGFjdGl2YXRlZCBhbmQgaGF2ZSB0aGVpciBjb250ZW50IGRpc3BsYXllZCB3aGVuIHRoZXkgcmVjZWl2ZSBmb2N1cy5cblx0ICovXG5cdEBJbnB1dCgpIGZvbGxvd0ZvY3VzOiBib29sZWFuO1xuXHQvKipcblx0ICogU2V0IHRvIGB0cnVlYCB0byBwdXQgdGFicyBpbiBhIGxvYWRpbmcgc3RhdGUuXG5cdCAqL1xuXHRASW5wdXQoKSBza2VsZXRvbiA9IGZhbHNlO1xuXHQvKipcblx0ICogU2V0cyB0aGUgYXJpYSBsYWJlbCBvbiB0aGUgbmF2IGVsZW1lbnQuXG5cdCAqL1xuXHRASW5wdXQoKSBhcmlhTGFiZWw6IHN0cmluZztcblx0LyoqXG5cdCAqIFNldHMgdGhlIGFyaWEgbGFiZWxsZWRieSBvbiB0aGUgbmF2IGVsZW1lbnQuXG5cdCAqL1xuXHRASW5wdXQoKSBhcmlhTGFiZWxsZWRieTogc3RyaW5nO1xuXG5cdEBJbnB1dCgpIGNvbnRlbnRBZnRlcjogVGVtcGxhdGVSZWY8YW55PjtcblxuXHRASW5wdXQoKSBjb250ZW50QmVmb3JlOiBUZW1wbGF0ZVJlZjxhbnk+O1xuXG5cdC8qKlxuXHQgKiBTZXQgdG8gJ3RydWUnIHRvIGhhdmUgYWxsIHBhbmUgcmVmZXJlbmNlcyBhc3NvY2lhdGVkIHdpdGggZWFjaCB0YWIgaGVhZGVyXG5cdCAqIGluIHRoZSB0YWIgaGVhZGVyIGdyb3VwIGNhY2hlZCBhbmQgbm90IHJlbG9hZGVkIG9uIHRhYiBzd2l0Y2hpbmcuXG5cdCAqL1xuXHRASW5wdXQoKSBjYWNoZUFjdGl2ZSA9IGZhbHNlO1xuXG5cdEBJbnB1dCgpIGlzTmF2aWdhdGlvbiA9IGZhbHNlO1xuXHRASW5wdXQoKSB0eXBlOiBcImRlZmF1bHRcIiB8IFwiY29udGFpbmVyXCIgPSBcImRlZmF1bHRcIjtcblxuXHQvKipcblx0ICogQ29udGVudENoaWxkcmVuIG9mIGFsbCB0aGUgdGFiSGVhZGVycy5cblx0ICovXG5cdEBDb250ZW50Q2hpbGRyZW4oVGFiSGVhZGVyKSB0YWJIZWFkZXJRdWVyeTogUXVlcnlMaXN0PFRhYkhlYWRlcj47XG5cdC8qKlxuXHQgKiBLZWVwcyB0cmFjayBvZiBhbGwgdGhlIHN1YnNjcmlwdGlvbnMgdG8gdGhlIHRhYiBoZWFkZXIgc2VsZWN0aW9uIGV2ZW50cy5cblx0ICovXG5cdHNlbGVjdGVkU3Vic2NyaXB0aW9uVHJhY2tlciA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuXHRwdWJsaWMgdGFiTGlzdFZpc2libGUgPSBmYWxzZTtcblx0LyoqXG5cdCAqIENvbnRyb2xzIHRoZSBtYW51YWwgZm9jdXNpbmcgZG9uZSBieSB0YWJiaW5nIHRocm91Z2ggaGVhZGluZ3MuXG5cdCAqL1xuXHRwdWJsaWMgY3VycmVudFNlbGVjdGVkSW5kZXggPSAwO1xuXG5cdHByaXZhdGUgX2NhY2hlQWN0aXZlID0gZmFsc2U7XG5cblx0Y29uc3RydWN0b3IocHJvdGVjdGVkIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHt9XG5cblx0Ly8ga2V5Ym9hcmQgYWNjZXNzaWJpbGl0eVxuXHQvKipcblx0ICogQ29udHJvbHMgdGhlIGtleWRvd24gZXZlbnRzIHVzZWQgZm9yIHRhYmJpbmcgdGhyb3VnaCB0aGUgaGVhZGluZ3MuXG5cdCAqL1xuXHRASG9zdExpc3RlbmVyKFwia2V5ZG93blwiLCBbXCIkZXZlbnRcIl0pXG5cdGtleWJvYXJkSW5wdXQoZXZlbnQpIHtcblx0XHRsZXQgdGFiSGVhZGVyc0FycmF5ID0gQXJyYXkuZnJvbTxhbnk+KHRoaXMudGFiSGVhZGVyUXVlcnkpO1xuXG5cdFx0aWYgKGV2ZW50LmtleSA9PT0gXCJSaWdodFwiIHx8IGV2ZW50LmtleSA9PT0gXCJBcnJvd1JpZ2h0XCIpIHtcblx0XHRcdGlmICh0aGlzLmN1cnJlbnRTZWxlY3RlZEluZGV4IDwgdGFiSGVhZGVyc0FycmF5Lmxlbmd0aCAtIDEpIHtcblx0XHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0aWYgKHRoaXMuZm9sbG93Rm9jdXMgJiYgIXRhYkhlYWRlcnNBcnJheVt0aGlzLmN1cnJlbnRTZWxlY3RlZEluZGV4ICsgMV0uZGlzYWJsZWQpIHtcblx0XHRcdFx0XHR0YWJIZWFkZXJzQXJyYXlbdGhpcy5jdXJyZW50U2VsZWN0ZWRJbmRleCArIDFdLnNlbGVjdFRhYigpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRhYkhlYWRlcnNBcnJheVt0aGlzLmN1cnJlbnRTZWxlY3RlZEluZGV4ICsgMV0udGFiSXRlbS5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG5cdFx0XHRcdFx0dGhpcy5jdXJyZW50U2VsZWN0ZWRJbmRleCsrO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0XHRpZiAodGhpcy5mb2xsb3dGb2N1cyAmJiAhdGFiSGVhZGVyc0FycmF5WzBdLmRpc2FibGVkKSB7XG5cdFx0XHRcdFx0dGFiSGVhZGVyc0FycmF5WzBdLnNlbGVjdFRhYigpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRhYkhlYWRlcnNBcnJheVswXS50YWJJdGVtLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcblx0XHRcdFx0XHR0aGlzLmN1cnJlbnRTZWxlY3RlZEluZGV4ID0gMDtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmIChldmVudC5rZXkgPT09IFwiTGVmdFwiIHx8IGV2ZW50LmtleSA9PT0gXCJBcnJvd0xlZnRcIikge1xuXHRcdFx0aWYgKHRoaXMuY3VycmVudFNlbGVjdGVkSW5kZXggPiAwKSB7XG5cdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdGlmICh0aGlzLmZvbGxvd0ZvY3VzICYmICF0YWJIZWFkZXJzQXJyYXlbdGhpcy5jdXJyZW50U2VsZWN0ZWRJbmRleCAtIDFdLmRpc2FibGVkKSB7XG5cdFx0XHRcdFx0dGFiSGVhZGVyc0FycmF5W3RoaXMuY3VycmVudFNlbGVjdGVkSW5kZXggLSAxXS5zZWxlY3RUYWIoKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR0YWJIZWFkZXJzQXJyYXlbdGhpcy5jdXJyZW50U2VsZWN0ZWRJbmRleCAtIDFdLnRhYkl0ZW0ubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuXHRcdFx0XHRcdHRoaXMuY3VycmVudFNlbGVjdGVkSW5kZXgtLTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0aWYgKHRoaXMuZm9sbG93Rm9jdXMgJiYgIXRhYkhlYWRlcnNBcnJheVt0YWJIZWFkZXJzQXJyYXkubGVuZ3RoIC0gMV0uZGlzYWJsZWQpIHtcblx0XHRcdFx0XHR0YWJIZWFkZXJzQXJyYXlbdGFiSGVhZGVyc0FycmF5Lmxlbmd0aCAtIDFdLnNlbGVjdFRhYigpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRhYkhlYWRlcnNBcnJheVt0YWJIZWFkZXJzQXJyYXkubGVuZ3RoIC0gMV0udGFiSXRlbS5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG5cdFx0XHRcdFx0dGhpcy5jdXJyZW50U2VsZWN0ZWRJbmRleCA9IHRhYkhlYWRlcnNBcnJheS5sZW5ndGggLSAxO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKGV2ZW50LmtleSA9PT0gXCJIb21lXCIpIHtcblx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRpZiAodGhpcy5mb2xsb3dGb2N1cyAmJiAhdGFiSGVhZGVyc0FycmF5WzBdLmRpc2FibGVkKSB7XG5cdFx0XHRcdHRhYkhlYWRlcnNBcnJheVswXS5zZWxlY3RUYWIoKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRhYkhlYWRlcnNBcnJheVswXS50YWJJdGVtLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcblx0XHRcdFx0dGhpcy5jdXJyZW50U2VsZWN0ZWRJbmRleCA9IDA7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKGV2ZW50LmtleSA9PT0gXCJFbmRcIikge1xuXHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdGlmICh0aGlzLmZvbGxvd0ZvY3VzICYmICF0YWJIZWFkZXJzQXJyYXlbdGFiSGVhZGVyc0FycmF5Lmxlbmd0aCAtIDFdLmRpc2FibGVkKSB7XG5cdFx0XHRcdHRhYkhlYWRlcnNBcnJheVt0YWJIZWFkZXJzQXJyYXkubGVuZ3RoIC0gMV0uc2VsZWN0VGFiKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0YWJIZWFkZXJzQXJyYXlbdGFiSGVhZGVyc0FycmF5Lmxlbmd0aCAtIDFdLnRhYkl0ZW0ubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuXHRcdFx0XHR0aGlzLmN1cnJlbnRTZWxlY3RlZEluZGV4ID0gdGFiSGVhZGVyc0FycmF5Lmxlbmd0aCAtIDE7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0Ly8gYFwiU3BhY2ViYXJcImAgaXMgSUUxMSBzcGVjaWZpYyB2YWx1ZVxuXHRcdGlmICgoZXZlbnQua2V5ID09PSBcIiBcIiB8fCBldmVudC5rZXkgPT09IFwiU3BhY2ViYXJcIikgJiYgIXRoaXMuZm9sbG93Rm9jdXMpIHtcblx0XHRcdHRhYkhlYWRlcnNBcnJheVt0aGlzLmN1cnJlbnRTZWxlY3RlZEluZGV4XS5zZWxlY3RUYWIoKTtcblx0XHR9XG5cblx0XHQvLyBkcm9wZG93biBsaXN0IGhhbmRsZXJcblx0XHRpZiAoZXZlbnQua2V5ID09PSBcIkVzY2FwZVwiKSB7XG5cdFx0XHR0aGlzLnRhYkxpc3RWaXNpYmxlID0gZmFsc2U7XG5cdFx0fVxuXHR9XG5cblx0QEhvc3RMaXN0ZW5lcihcImZvY3Vzb3V0XCIsIFtcIiRldmVudFwiXSlcblx0Zm9jdXNPdXQoZXZlbnQpIHtcblx0XHRpZiAodGhpcy50YWJMaXN0VmlzaWJsZSAmJiAhdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY29udGFpbnMoZXZlbnQucmVsYXRlZFRhcmdldCkpIHtcblx0XHRcdHRoaXMudGFiTGlzdFZpc2libGUgPSBmYWxzZTtcblx0XHR9XG5cdH1cblxuXHRuZ0FmdGVyQ29udGVudEluaXQoKSB7XG5cdFx0dGhpcy5zZWxlY3RlZFN1YnNjcmlwdGlvblRyYWNrZXIudW5zdWJzY3JpYmUoKTtcblxuXHRcdGlmICh0aGlzLnRhYkhlYWRlclF1ZXJ5KSB7XG5cdFx0XHR0aGlzLnRhYkhlYWRlclF1ZXJ5LnRvQXJyYXkoKVxuXHRcdFx0XHQuZm9yRWFjaCh0YWJIZWFkZXIgPT4ge1xuXHRcdFx0XHRcdHRhYkhlYWRlci5jYWNoZUFjdGl2ZSA9IHRoaXMuY2FjaGVBY3RpdmU7XG5cdFx0XHRcdFx0dGFiSGVhZGVyLnBhbmVUYWJJbmRleCA9IHRoaXMuaXNOYXZpZ2F0aW9uID8gbnVsbCA6IDA7XG5cdFx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdGNvbnN0IHNlbGVjdGVkU3Vic2NyaXB0aW9ucyA9IHRoaXMudGFiSGVhZGVyUXVlcnkudG9BcnJheSgpLmZvckVhY2godGFiSGVhZGVyID0+IHtcblx0XHRcdHRhYkhlYWRlci5zZWxlY3RlZC5zdWJzY3JpYmUoKCkgPT4ge1xuXHRcdFx0XHR0aGlzLmN1cnJlbnRTZWxlY3RlZEluZGV4ID0gdGhpcy50YWJIZWFkZXJRdWVyeS50b0FycmF5KCkuaW5kZXhPZih0YWJIZWFkZXIpO1xuXHRcdFx0XHQvLyBUaGUgRmlsdGVyIHRha2VzIHRoZSBjdXJyZW50IHNlbGVjdGVkIHRhYiBvdXQsIHRoZW4gYWxsIG90aGVyIGhlYWRlcnMgYXJlXG5cdFx0XHRcdC8vIGRlYWN0aXZhdGVkIGFuZCB0aGVpciBhc3NvY2lhdGVkIHBhbmUgcmVmZXJlbmNlcyBhcmUgYWxzbyBkZWFjdGl2YXRlZC5cblx0XHRcdFx0dGhpcy50YWJIZWFkZXJRdWVyeS50b0FycmF5KCkuZmlsdGVyKGhlYWRlciA9PiBoZWFkZXIgIT09IHRhYkhlYWRlcilcblx0XHRcdFx0XHQuZm9yRWFjaChmaWx0ZXJlZEhlYWRlciA9PiB7XG5cdFx0XHRcdFx0XHRmaWx0ZXJlZEhlYWRlci5hY3RpdmUgPSBmYWxzZTtcblx0XHRcdFx0XHRcdGlmIChmaWx0ZXJlZEhlYWRlci5wYW5lUmVmZXJlbmNlKSB7XG5cdFx0XHRcdFx0XHRcdGZpbHRlcmVkSGVhZGVyLnBhbmVSZWZlcmVuY2UuYWN0aXZlID0gZmFsc2U7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0XHR0aGlzLnNlbGVjdGVkU3Vic2NyaXB0aW9uVHJhY2tlci5hZGQoc2VsZWN0ZWRTdWJzY3JpcHRpb25zKTtcblxuXHRcdHNldFRpbWVvdXQoKCkgPT4gdGhpcy50YWJIZWFkZXJRdWVyeS50b0FycmF5KClbdGhpcy5jdXJyZW50U2VsZWN0ZWRJbmRleF0uc2VsZWN0VGFiKCkpO1xuXHR9XG5cblx0bmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuXHRcdGlmICh0aGlzLnRhYkhlYWRlclF1ZXJ5KSB7XG5cdFx0XHRpZiAoY2hhbmdlcy5jYWNoZUFjdGl2ZSkge1xuXHRcdFx0XHR0aGlzLnRhYkhlYWRlclF1ZXJ5LnRvQXJyYXkoKS5mb3JFYWNoKHRhYkhlYWRlciA9PiB0YWJIZWFkZXIuY2FjaGVBY3RpdmUgPSB0aGlzLmNhY2hlQWN0aXZlKTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKGNoYW5nZXMuaXNOYXZpZ2F0aW9uKSB7XG5cdFx0XHRcdHRoaXMudGFiSGVhZGVyUXVlcnkudG9BcnJheSgpXG5cdFx0XHRcdFx0LmZvckVhY2godGFiSGVhZGVyID0+IHRhYkhlYWRlci5wYW5lVGFiSW5kZXggPSB0aGlzLmlzTmF2aWdhdGlvbiA/IG51bGwgOiAwKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgZ2V0U2VsZWN0ZWRUYWIoKTogYW55IHtcblx0XHRjb25zdCBzZWxlY3RlZCA9ICB0aGlzLnRhYkhlYWRlclF1ZXJ5LnRvQXJyYXkoKVt0aGlzLmN1cnJlbnRTZWxlY3RlZEluZGV4XTtcblx0XHRpZiAoc2VsZWN0ZWQpIHtcblx0XHRcdHJldHVybiBzZWxlY3RlZDtcblx0XHR9XG5cdFx0cmV0dXJuIHtcblx0XHRcdGhlYWRpbmdJc1RlbXBsYXRlOiBmYWxzZSxcblx0XHRcdGhlYWRpbmc6IFwiXCJcblx0XHR9O1xuXHR9XG5cblx0cHVibGljIHNob3dUYWJMaXN0KCkge1xuXHRcdHRoaXMudGFiTGlzdFZpc2libGUgPSB0cnVlO1xuXHRcdGNvbnN0IGZvY3VzVGFyZ2V0ID0gdGhpcy50YWJIZWFkZXJRdWVyeS50b0FycmF5KCkuZmluZCh0YWIgPT4ge1xuXHRcdFx0Y29uc3QgdGFiQ29udGFpbmVyID0gdGFiLnRhYkl0ZW0ubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50O1xuXHRcdFx0cmV0dXJuICF0YWJDb250YWluZXIuY2xhc3NMaXN0LmNvbnRhaW5zKFwiYngtLXRhYnNfX25hdi1pdGVtLS1zZWxlY3RlZFwiKTtcblx0XHR9KTtcblx0XHRmb2N1c1RhcmdldC50YWJJdGVtLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcblx0fVxuXG5cdHB1YmxpYyBvbkRyb3Bkb3duS2V5ZG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuXHRcdHN3aXRjaCAoZXZlbnQua2V5KSB7XG5cdFx0XHRjYXNlIFwiIFwiOlxuXHRcdFx0Y2FzZSBcIlNwYWNlYmFyXCI6XG5cdFx0XHRjYXNlIFwiRW50ZXJcIjpcblx0XHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0dGhpcy5zaG93VGFiTGlzdCgpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyB0YWJEcm9wZG93bktleWRvd24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcblx0XHRpZiAoIXRoaXMudGFiTGlzdFZpc2libGUpIHsgcmV0dXJuOyB9XG5cblx0XHRjb25zdCB0YXJnZXQgPSAoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS5jbG9zZXN0KFwiYVwiKTtcblxuXHRcdGNvbnN0IGhlYWRlcnMgPSB0aGlzLnRhYkhlYWRlclF1ZXJ5LnRvQXJyYXkoKS5maWx0ZXIodGFiID0+XG5cdFx0XHQhdGFiLnRhYkl0ZW0ubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyhcImJ4LS10YWJzX19uYXYtaXRlbS0tZGlzYWJsZWRcIikgJiZcblx0XHRcdCF0YWIudGFiSXRlbS5uYXRpdmVFbGVtZW50LnBhcmVudEVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKFwiYngtLXRhYnNfX25hdi1pdGVtLS1zZWxlY3RlZFwiKSk7XG5cblx0XHQvLyB1bmxlc3MgZm9jdXMgY2FuIG1vdmUsIGl0IHNob3VsZCByZW1haW4gb24gdGhlIHRhcmdldFxuXHRcdGxldCBuZXh0OiBIVE1MRWxlbWVudCA9IHRhcmdldDtcblx0XHRsZXQgcHJldmlvdXM6IEhUTUxFbGVtZW50ID0gdGFyZ2V0O1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBoZWFkZXJzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRpZiAoaGVhZGVyc1tpXS50YWJJdGVtLm5hdGl2ZUVsZW1lbnQgPT09IHRhcmdldCkge1xuXHRcdFx0XHRpZiAoaSArIDEgPCBoZWFkZXJzLmxlbmd0aCkge1xuXHRcdFx0XHRcdG5leHQgPSBoZWFkZXJzW2kgKyAxXS50YWJJdGVtLm5hdGl2ZUVsZW1lbnQ7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKGkgLSAxID49IDApIHtcblx0XHRcdFx0XHRwcmV2aW91cyA9IGhlYWRlcnNbaSAtIDFdLnRhYkl0ZW0ubmF0aXZlRWxlbWVudDtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHN3aXRjaCAoZXZlbnQua2V5KSB7XG5cdFx0XHRjYXNlIFwiQXJyb3dEb3duXCI6XG5cdFx0XHRjYXNlIFwiRG93blwiOiAvLyBJRTExIHNwZWNpZmljIHZhbHVlXG5cdFx0XHRcdG5leHQuZm9jdXMoKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIFwiQXJyb3dVcFwiOlxuXHRcdFx0Y2FzZSBcIlVwXCI6IC8vIElFMTEgc3BlY2lmaWMgdmFsdWVcblx0XHRcdFx0cHJldmlvdXMuZm9jdXMoKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cdH1cblxuXHRuZ09uRGVzdHJveSgpIHtcblx0XHR0aGlzLnNlbGVjdGVkU3Vic2NyaXB0aW9uVHJhY2tlci51bnN1YnNjcmliZSgpO1xuXHR9XG59XG4iXX0=